<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3-Nin Launcher V15+</title>
    <meta name="theme-color" content="#3e4d3f">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-512.png">

    <style>
        :root { 
            --bg: #2d362e; --header-bg: #3e4d3f; --card-bg: #4a5d4c; 
            --border: #6b826d; --text-main: #e8f5e9; --text-sub: #a5d6a7; 
            --accent: #81c784; --delete-bg: #e57373; 
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; color: var(--text-main); }
        .header { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; padding: 8px; background: var(--header-bg); border-bottom: 2px solid var(--border); }
        .header button { padding: 10px 0; font-size: 0.85rem; font-weight: bold; border: 1.5px solid var(--border); border-radius: 8px; background: #4a5d4c; color: var(--text-main); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .btn-active { border-color: var(--accent) !important; color: var(--accent) !important; background: var(--bg) !important; }
        .app-list { flex: 1; overflow-y: auto; padding: 6px; }
        .app-item { display: flex; align-items: center; background: var(--card-bg); border: 1.2px solid var(--border); border-radius: 12px; margin-bottom: 6px; padding: 8px 12px; height: 66px; transition: transform 0.2s, opacity 0.2s; }
        .app-item.dragging { opacity: 0.5; background: var(--accent); transform: scale(0.98); }
        .icon-area { width: 52px; height: 52px; min-width: 52px; background: #2d362e; border: 1px solid var(--border); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: bold; color: var(--accent); overflow: hidden; cursor: grab; }
        .icon-area img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .info-container { flex: 1; margin-left: 14px; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .row-text { display: flex; align-items: baseline; gap: 10px; white-space: nowrap; overflow: hidden; }
        .app-title { font-size: 1.15rem; font-weight: 800; color: var(--text-main); }
        .app-desc { font-size: 0.85rem; color: var(--text-sub); text-overflow: ellipsis; overflow: hidden; }
        .row-buttons { display: none; margin-top: 6px; gap: 6px; }
        .edit-mode .row-buttons { display: flex; }
        .row-buttons button { flex: 1; font-size: 0.75rem; padding: 5px 0; border: 1px solid var(--border); border-radius: 6px; background: #5a725c; color: white; font-weight: bold; }
        .del-btn { background: var(--delete-bg) !important; border-color: #c62828 !important; }
        .app-list::-webkit-scrollbar { width: 4px; }
        .app-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
    </style>
</head>
<body>

    <div class="header">
        <input type="file" id="txtFileInput" accept=".txt" style="display:none;" onchange="handleTxtFile(this)">
        <button onclick="document.getElementById('txtFileInput').click()">TXT読込</button>
        <button id="editToggleBtn" onclick="toggleEdit()">整理/編集</button>
        <button onclick="exportData()">保存(JSON)</button>
        <button onclick="importData()">復元(JSON)</button>
    </div>

    <input type="file" id="iconFileInput" accept="image/*" style="display:none;">
    <div id="appList" class="app-list"></div>

<script>
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(reg => {
                console.log('SW registered!', reg);
            }).catch(err => console.log('SW registration failed:', err));
        });
    }

    let isEditMode = false;
    let myApps = JSON.parse(localStorage.getItem('launcher-v15')) || [];
    let currentEditingId = null;

    function getAutoIconUrl(url) {
        try { const domain = new URL(url).hostname; return `https://icons.duckduckgo.com/ip3/${domain}.ico`; } 
        catch (e) { return null; }
    }

    function render() {
        const list = document.getElementById('appList');
        list.innerHTML = '';
        document.body.classList.toggle('edit-mode', isEditMode);
        const toggleBtn = document.getElementById('editToggleBtn');
        toggleBtn.classList.toggle('btn-active', isEditMode);
        toggleBtn.innerText = isEditMode ? "完了" : "整理/編集";

        myApps.forEach((app, index) => {
            const item = document.createElement('div');
            item.className = 'app-item';
            item.draggable = isEditMode;
            item.dataset.index = index;
            if(isEditMode) {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            }
            const iconSrc = app.customIcon || getAutoIconUrl(app.url);
            item.innerHTML = `
                <div class="icon-area" onclick="launch('${app.url}')">
                    <img src="${iconSrc}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                    <span style="display:none">${app.name.charAt(0)}</span>
                </div>
                <div class="info-container">
                    <div class="row-text" onclick="launch('${app.url}')">
                        <span class="app-title">${app.name}</span>
                        <span class="app-desc">${app.desc || '(説明なし)'}</span>
                    </div>
                    <div class="row-buttons">
                        <button onclick="triggerIconEdit('${app.id}')">アイコン</button>
                        <button onclick="editDesc('${app.id}')">説明</button>
                        <button class="del-btn" onclick="deleteApp('${app.id}')">削除</button>
                    </div>
                </div>
            `;
            list.appendChild(item);
        });
        localStorage.setItem('launcher-v15', JSON.stringify(myApps));
    }

    let dragSrcIndex = null;
    function handleDragStart(e) { dragSrcIndex = this.dataset.index; this.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; }
    function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); return false; }
    function handleDrop(e) {
        if (e.stopPropagation) e.stopPropagation();
        const targetIndex = this.dataset.index;
        if (dragSrcIndex !== targetIndex) {
            const movedItem = myApps.splice(dragSrcIndex, 1)[0];
            myApps.splice(targetIndex, 0, movedItem);
            render();
        }
        return false;
    }
    function handleDragEnd() { this.classList.remove('dragging'); }

    function handleTxtFile(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = e => processRawText(e.target.result);
        reader.readAsText(file, 'UTF-8');
        input.value = ''; 
    }
    function processRawText(text) {
        const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
        lines.forEach(line => {
            const parts = line.trim().split(/[\s　\t]+/);
            if (parts.length >= 2) {
                const name = parts[0], url = parts[parts.length - 1].trim();
                if (url.toLowerCase().includes('http') && !myApps.some(a => a.url === url)) {
                    myApps.push({ id: 'id-'+Date.now()+'-'+Math.random().toString(36).substr(2,5), name, url, desc: "", customIcon: null });
                }
            }
        });
        render();
    }
    function triggerIconEdit(id) { currentEditingId = id; document.getElementById('iconFileInput').click(); }
    document.getElementById('iconFileInput').onchange = function(e) {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => { 
            const app = myApps.find(a => a.id === currentEditingId);
            if(app) { app.customIcon = ev.target.result; render(); }
        };
        reader.readAsDataURL(file);
    };
    function launch(url) { if (!isEditMode) window.location.href = url; }
    function toggleEdit() { isEditMode = !isEditMode; render(); }
    function editDesc(id) {
        const app = myApps.find(a => a.id === id);
        const d = prompt(app.name + " の説明", app.desc);
        if (d !== null) { app.desc = d; render(); }
    }
    function deleteApp(id) { if (confirm("削除しますか？")) { myApps = myApps.filter(a => a.id !== id); render(); } }
    function exportData() {
        const blob = new Blob([JSON.stringify(myApps)], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'launcher_pwa_backup.json'; a.click();
    }
    function importData() {
        const input = document.createElement('input'); input.type = 'file'; input.accept = '.json';
        input.onchange = e => {
            const reader = new FileReader();
            reader.onload = () => { myApps = JSON.parse(reader.result); render(); };
            reader.readAsText(e.target.files[0]);
        };
        input.click();
    }
    render();
</script>
</body>
</html>
